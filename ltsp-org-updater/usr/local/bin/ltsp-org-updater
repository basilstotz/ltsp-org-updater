#!/bin/sh


test "$(id --user)" = 0 || exec sudo "$0" "$@"

PFAD="/srv/ltsp/images"

on_exit(){
    test -f /run/ltsp-org-updater.lock && rm /run/ltsp-org-updater.lock
}

trap on_exit EXIT
trap on_exit INT


#ltsp
ltsp_prepare(){
    test -f /etc/ltsp/ltsp.conf && return

    
    mkdir -p /etc/ltsp
    
    cat <<EOF >  /etc/ltsp/ltsp.conf
[server]
ADD_IMAGE_EXCLUDES="/etc/ltsp/conf/add-image.excludes"
KERNEL_PARAMETERS="locales=de_CH.UTF-8 keyboard-layouts=ch,esus timezone=Europe/Zurich hotspot=escuela,escuela0815"
#DEFAULT_IMAGE="x86_64"
[common]
#GDM3_CONF="WaylandEnable=false"  
[clients]
#CRONTAB_x="30 15 * * * poweroff"
POST_INIT_RUN_PARTS="/usr/bin/run-parts /etc/ltsp/init/" 
EOF
    chown :sudo /etc/ltsp/ltsp.conf
    chmod 660 /etc/ltsp/ltsp.conf

    mkdir -p /etc/ltsp/conf
    cat <<EOF > /etc/ltsp/conf/add-image.excludes
usr/local/bin/ltsp-org-updater
usr/share/applications/org.gnome.Software.desktop
usr/bin/gnome-software
EOF
    
    cat <<'EOF' > /srv/tftp/Makefile
DIR:=/srv/tftp/ltsp

.PHONY: update
update: $(DIR)/ltsp.img 

$(DIR)/ltsp.img: /etc/passwd /etc/group /etc/shadow /etc/ltsp/ltsp.conf  /etc/ltsp/init/* /etc/ltsp/bin/*
	ltsp initrd
	ltsp ipxe
	cp /etc/passwd /etc/ltsp/login/passwd
	cp /etc/group /etc/ltsp/login/group
	cp /etc/shadow /etc/ltsp/login/shadow
	test -f /etc/gshadow && cp /etc/gshadow /etc/ltsp/login/gshadow
EOF

    cat <<EOF > /etc/default/ltsp
RUN=true
LERNSTICK_NAME="lernstick_debian11_latest.iso"
LERNSTICK_URL="https://releases.lernstick.ch"
EOF
}

install_ltsp(){
    if grep -q Debian /etc/issue;then
       curl -s -o /etc/apt/sources.list.d/ltsp-ubuntu-ppa-focal.list https://ltsp.org/misc/ltsp-ubuntu-ppa-focal.list 
       curl -s -o /etc/apt/trusted.gpg.d/ltsp_ubuntu_ppa.gpg https://ltsp.org/misc/ltsp_ubuntu_ppa.gpg  
    else
       add-apt-repository --yes ppa:ltsp
    fi    

    apt-get --yes update
    for P in debconf dnsmasq nfs-kernel-server ssh squashfs-tools ethtool net-tools epoptes epoptes-client sshfs man-db wget ; do
	echo "===================== $P =========================================="
	apt-get --yes install "$P"
    done
    apt-get --yes --install-recommends install ltsp ltsp-binaries

    mkdir -p /srv/ltsp/images/
    mkdir -p /srv/tftp/ltsp/

    mkdir -p /srv/iso/lernstick
    
    mkdir -p /etc/ltsp/bin/
    mkdir -p /etc/ltsp/init/
    mkdir -p /etc/ltsp/conf/
    mkdir -p /etc/ltsp/login/
    
    ltsp_prepare

    chown root:sudo /srv/iso
    chmod 770 /srv/iso

}


update_kernel(){
    if test -n "$(ls $PFAD )";then
	for I in $(ls $PFAD/*.img);do
	    BI=$(basename -s .img "$I")
	    if test "$BI" = "lernstick";then
		ltsp kernel "$BI" --kernel-initrd="live/vmlinuz* s|vmlinuz|initrd.img|"

	    else
		ltsp kernel "$BI"
	    fi
	done
    fi
}

update_config(){
     update_daemons
     update_kernel
     ltsp initrd
     ltsp ipxe
}

update_image(){
     ltsp image /
     update_kernel
     ltsp initrd           #maybe not needed
     ltsp ipxe
}

update_lernstick(){
	
     mkdir -p /srv/iso/lernstick
     mkdir -p /srv/ltsp/images/
     cd /srv/iso/lernstick
     URL="https://www.amxa.ch/debian/lernstick"
     NAME="lernstick_debian11_latest"
     test -f "$NAME.iso.md5" || touch "$NAME.iso.md5"
     if wget -O "$NAME.iso.md5.tmp" "$URL/$NAME.iso.md5" 2>/dev/null;then
	 if ! diff "$NAME.iso.md5" "$NAME.iso.md5.tmp" >/dev/null;then
	     if wget -c -O "$NAME.iso.tmp" "$URL/$NAME.iso" ;then
		 #we have a new image!
		 mv "$NAME.iso.md5.tmp" "$NAME.iso.md5"
		 REALNAME=$(cat "$NAME.iso.md5"|xargs|cut -d" " -f2)
		 mv "$NAME.iso.tmp" "$REALNAME"
		 if md5sum -c "$NAME.iso.md5"; then
		     #ok, install it
		     test -f /srv/ltsp/images/lernstick.img && rm /srv/ltsp/images/lernstick.img
		     ln "$REALNAME" /srv/ltsp/images/lernstick.img
		     update_kernel
		     ltsp initrd     #maybe not needed
		     ltsp ipxe
		     echo "info: succesfully downloaded and installed $REALNAME"
		 else
		     echo "error: md5sum did not match. purge downloaded files"
		     rm "$REALNAME"
		     rm "$NAME.iso.md5"
		 fi
		 # purge old images
		 find . -name "lernstick*.iso" -mtime +365 -exec rm \{\} \;
	     else
		 echo "error: could not download $NAME.iso"
	     fi
	 else
	     rm "$NAME.iso.md5.tmp"
	     #echo "info: all is up to date. do nothing"
	 fi
     else
	 echo "error: could not download $NAME.iso.md5"
     fi
}

link_iso(){

    dirty=false
    for iso in $(find /srv/iso/ -name ".*.iso"); do
	i=$(basename -s .iso $iso)
	if ! test -f /srv/ltsp/images/$i.img;then
	    ln $iso /srv/ltsp/images/$i.img
	    dirty=true
	fi
    done
    if dirty;then ltsp ipxe;fi		    
}


update_both(){
    if test -f "$PFAD/x86_64.img"; then
	update_image
    fi
    if test -f "$PFAD/lernstick.img";then
	update_lernstick
    fi
}

ltsp_daemons(){
    	# init nfs
    if ! test -f /etc/exports.d/ltsp-nfs.exports; then
	ltsp nfs
    fi
    # init dnsmasq
    while ! nm-online -t 3600; do
	true
    done 
    ltsp dnsmasq
    # update initrd
    while true; do
	make --directory /srv/tftp update
	#link_iso
	sleep 60
    done
}

#main

# checks and specials
if test -z "$(command -v ltsp)"; then
    if ! test "$1" = "--install"; then
	exit 0
    fi
else
    if test "$1" = "--daemons"; then
	ltsp_daemons
	#never reaches here!
	exit 1
    fi
fi

#ok
if ! test -f /run/ltsp-org-updater.lock;then
    touch /run/ltsp-org-updater.lock
    case "$1" in
	 --install)
	     install_ltsp
	     ;;
	 --update)
 	     #also called by cron once a day
	     update_both
	     ;;
	 --config)
	     update_config
	     ;;
	 --image)
 	     update_image
	     ;;
	 --lernstick)
	     update_lernstick
	     ;;
	 *)
	     echo "usage $(basename $0) --config | --image | --lernstick | --update"
	     ;;
    esac
    rm /run/ltsp-org-updater.lock
else
    echo "error: ltsp-org-updater is busy. try later again"
fi

exit
