#!/bin/sh

test "$(id --user)" = 0 || exec sudo $0 $@

PFAD="/srv/ltsp/images"

echo $0 $@

#ltsp
ltsp_prepare(){
    test -f /etc/ltsp/ltsp.conf && return
    
cat <<EOF >  /etc/ltsp/ltsp.conf
[server]
ADD_IMAGE_EXCLUDES="/etc/ltsp/add-image.excludes"
[common]
#GDM3_CONF="WaylandEnable=false"  
[clients]
#CRONTAB_x="30 15 * * * poweroff" 
EOF

cat <<EOF > /etc/ltsp/add-image.excludes
usr/local/bin/ltsp-org-updater
usr/share/applications/org.gnome.Software.desktop
usr/bin/gnome-software
EOF

}

install_ltsp(){
    if grep -q Debian /etc/issue;then
       wget https://ltsp.org/misc/ltsp-ubuntu-ppa-focal.list -O /etc/apt/sources.list.d/ltsp-ubuntu-ppa-focal.list
       wget https://ltsp.org/misc/ltsp_ubuntu_ppa.gpg  -O /etc/apt/trusted.gpg.d/ltsp_ubuntu_ppa.gpg
    else
       add-apt-repository --yes ppa:ltsp
    fi    

    apt-get --yes update
    apt-get --yes install debconf, zenity, dnsmasq, nfs-kernel-server, openssh-server, squashfs-tools, ethtool, net-tools, epoptes, epoptes-client, sshfs, man-db, wget 
    apt-get --yes --install-recommends install ltsp ltsp-binaries
    ltsp_prepare
}

update_config(){
    ip route|grep -q default  &&  ltsp dnsmasq
    ltsp nfs
    for I in $(ls $PFAD/*.img);do
	BI=$(basename -s .img $I)
	if "$BI" = "lernstick";then
	    ltsp kernel $BI --kernel-initrd="live/vmlinuz* s|vmlinuz|initrd.img|"

	else
	    ltsp kernel $BI
	fi
    done
    ltsp initrd
    ltsp ipxe
}

update_image(){
    ltsp image /
}


#main
if test "$1" = "--install" -o -n "$(command -v ltsp)";then
    case "$1" in
	 #systemd
	 --daemon)
	     while ! nm-online -t 3600; do
		 true
	     done
	     update_config
	     sleep infinity
	     ;;
	 --update-image)
	     UPTIME=$(cat /proc/uptime|cut -d\  -f1|cut -d. -f1)
	     if test "$UPTIME" -gt 120 -a -f $PFAD/x86_64.img; then
		 update_image
		 update_config
	     fi
	     ;;
	 #user
	 --install)
	     install_ltsp
	     ;;
	 --config)
	     update_config
	     ;;
	 --image)
 	     update_image
	     update_config
	     ;;
	 --lernstick)
	     if wget -C -O $PFAD/lernstick.img.tmp https://releases.lernstick.ch/lernstick_debian11_latest.iso;then
		 mv $PFAD/lernstick.img.tmp $PFAD/lernstick.img
		 update_config
	     fi
	     ;;
	 *)
	     echo "usage $(basename $0) --install | --config | --image | --lernstick"
	     ;;
     esac
fi
exit






#######################################################################

# for zenity
progress(){
    OLD=$(stat --format=%s /srv/ltsp/images/x86_64.img.old)
    test -n "$OLD" || OLD="4000000000"
    
    echo 5
    while test -z "$(find /srv/ltsp/images -name x86_64.img.tmp)";do sleep 5;done
    while test -n "$(find /srv/ltsp/images -name x86_64.img.tmp)";do
        NEW=$(stat --format=%s /srv/ltsp/images/x86_64.img.tmp)
        PERCENT=$(( NEW * 95 / OLD ))
        test $PERCENT -gt 5 && echo $PERCENT
        sleep 5
    done
    echo 100
}

show_update(){
    zenity --progress --title="LTSP-Updater"  \
	   --no-cancel --auto-close
}

show_install(){
    zenity --title="LTSP-Installer" --progress \
	   --pulsate --no-cancel --auto-close
}

show_success(){
    zenity --info --title="LTSP-Updater"
}

# old main
if test "$1" = "--nogui" ;then
    GUI=false;
else
    GUI=true;
fi

if $GUI; then
    LOG="/var/log/ltsp-updater.log"
    date > $LOG
    if test -z "$(command -v ltsp)";then
	(install_ltsp 2>&1 >> $LOG;echo "100") | show_install 
    fi
    update_image 2>&1 >> $LOG | progress | show_update 
    show_success
else
    if test -z "$(command -v ltsp)";then
	install_ltsp  
    fi
    update_image
fi

exit
